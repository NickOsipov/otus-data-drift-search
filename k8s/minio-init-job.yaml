apiVersion: batch/v1
kind: Job
metadata:
  name: minio-init
  namespace: drift-detection
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-minio
        image: alpine:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "ðŸ“¦ Installing MinIO Client and curl..."
            apk add --no-cache curl
            wget https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mc
            chmod +x /usr/local/bin/mc
            
            echo "ðŸ”§ Waiting for MinIO to be ready..."
            until mc alias set myminio http://minio.drift-detection.svc.cluster.local:9000 minio minio123; do
              echo "MinIO not ready yet, waiting..."
              sleep 5
            done
            
            echo "âœ… MinIO is ready!"
            
            echo "ðŸ“¦ Creating buckets..."
            mc mb myminio/datasets --ignore-existing
            mc mb myminio/mlflow --ignore-existing
            
            echo "ðŸ“¥ Downloading reference data from GitHub..."
            curl -L -o /tmp/reference.csv https://raw.githubusercontent.com/NickOsipov/small-datasets/refs/heads/main/data/reference.csv
            
            echo "ðŸ“¤ Uploading reference data to MinIO..."
            mc cp /tmp/reference.csv myminio/datasets/reference.csv
            
            echo "âœ… MinIO initialization completed!"
            mc ls myminio/datasets/
